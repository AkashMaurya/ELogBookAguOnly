{% extends 'base.html' %}

{% block title %}Staff Dashboard{% endblock %}

{% block navbar %}
  {% include 'components/staff_auth_navbar.html' %}
{% endblock %}

{% block content %}
  <div class="text-center p-10 mt-2">
    <!-- Dashboard Header -->
    <div class="text-center my-6 animate-slide-in">
      <h2 class="text-4xl font-bold dark:text-white bg-gradient-to-r from-purple-500 to-indigo-500 dark:from-purple-400 dark:to-indigo-400 text-transparent bg-clip-text">Welcome, {{ request.session.first_name }}</h2>
      <p class="text-gray-600 dark:text-gray-300 mt-2">Review student records and manage your tasks efficiently.</p>
    </div>

    <!-- Dashboard Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
      <!-- Total Records to Review -->
      <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4 transform transition-all duration-300 hover:scale-105 animate-pulse-card">
        <img src="https://cdn-icons-png.flaticon.com/512/1160/1160758.png" class="w-14 h-14" alt="Records Icon" />
        <div>
          <h3 class="text-xl font-semibold dark:text-white">Total Records</h3>
          <p class="text-3xl font-bold text-purple-600 dark:text-purple-400">{{ total_records|default:0 }}</p>
        </div>
      </div>

      <!-- Records Left to Review -->
      <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4 transform transition-all duration-300 hover:scale-105 animate-pulse-card">
        <img src="https://cdn-icons-png.flaticon.com/512/1008/1008928.png" alt="Pending Icon" class="w-14 h-14" />
        <div>
          <h3 class="text-xl font-semibold dark:text-white">Left to Review</h3>
          <p class="text-3xl font-bold text-red-600 dark:text-red-400">{{ left_to_review|default:0 }}</p>
        </div>
      </div>

      <!-- Reviewed Records -->
      <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4 transform transition-all duration-300 hover:scale-105 animate-pulse-card">
        <img src="https://cdn-icons-png.flaticon.com/512/190/190411.png" alt="Reviewed Icon" class="w-14 h-14" />
        <div>
          <h3 class="text-xl font-semibold dark:text-white">Reviewed</h3>
          <p class="text-3xl font-bold text-green-600 dark:text-green-400">{{ reviewed|default:0 }}</p>
        </div>
      </div>
    </div>

    <!-- Staff Info and Quick Links -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
      <!-- Staff Info with Progress Circle -->
      <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg flex flex-col items-center justify-center min-h-[250px] transform transition-all duration-300 hover:shadow-xl">
        <h3 class="text-2xl font-semibold dark:text-white mb-4 text-center">Your Progress</h3>
        <!-- Progress Circle with JavaScript-based calculation -->
        <div class="relative w-32 h-32 flex items-center justify-center">
          <svg class="w-full h-full" viewBox="0 0 100 100">
            <circle class="text-gray-200 dark:text-gray-600 stroke-current" stroke-width="10" cx="50" cy="50" r="40" fill="transparent"></circle>
            <circle id="progress-circle" class="text-indigo-500 progress-ring stroke-current" stroke-width="10" stroke-linecap="round" cx="50" cy="50" r="40" fill="transparent" stroke-dasharray="251.2" stroke-dashoffset="251.2"></circle>
          </svg>
          <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-2xl font-bold dark:text-white">
            {{ review_percentage }}%
          </div>
        </div>

        <!-- Script to update progress circle -->
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            const progressCircle = document.getElementById('progress-circle');
            const percentage = {{ review_percentage }};
            const dashArray = 251.2;
            const dashOffset = dashArray - (dashArray * percentage) / 100;

            if (progressCircle) {
              progressCircle.style.strokeDashoffset = dashOffset;
            }
          });
        </script>
        <p class="text-gray-800 dark:text-gray-200 mt-4 text-center">{{ reviewed }} reviewed out of {{ total_records }} total records</p>
      </div>

      <!-- Quick Links -->
      <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg transform transition-all duration-300 hover:shadow-xl">
        <h3 class="text-2xl font-semibold dark:text-white mb-4">Quick Actions</h3>
        <div class="space-y-3">
          <a href="{% url 'staff_section:staff_reviews' %}" class="block py-3 px-6 bg-gradient-to-r from-purple-500 to-indigo-700 dark:from-purple-600 dark:to-indigo-800 text-white rounded-lg hover:from-purple-600 hover:to-indigo-800 dark:hover:from-purple-700 dark:hover:to-indigo-900 transition duration-300 transform hover:-translate-y-1"><i class="fas fa-clipboard-check mr-2"></i> Review Records</a>
          <a href="{% url 'staff_section:staff_blogs' %}" class="block py-3 px-6 bg-gradient-to-r from-green-500 to-green-700 dark:from-green-600 dark:to-green-800 text-white rounded-lg hover:from-green-600 hover:to-green-800 dark:hover:from-green-700 dark:hover:to-green-900 transition duration-300 transform hover:-translate-y-1"><i class="fas fa-users mr-2"></i>Posts</a>
          <a href="{% url 'staff_section:staff_support' %}" class="block py-3 px-6 bg-gradient-to-r from-blue-500 to-blue-700 dark:from-blue-600 dark:to-blue-800 text-white rounded-lg hover:from-blue-600 hover:to-blue-800 dark:hover:from-blue-700 dark:hover:to-blue-900 transition duration-300 transform hover:-translate-y-1"><i class="fas fa-chart-bar mr-2"></i> Support</a>
        </div>
      </div>
    </div>

    <!-- Filters Section -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-10">
      <h3 class="text-2xl font-semibold dark:text-white mb-4">Dashboard Filters</h3>

      <!-- Department Filter -->
      <div class="mb-6">
        <h4 class="text-lg font-medium dark:text-white mb-2">Department Filter</h4>
        <div class="flex flex-wrap gap-4">
          <a href="{% url 'staff_section:staff_dash' %}{% if selected_doctor %}?doctor={{ selected_doctor }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}"
             class="py-2 px-4 {% if not selected_department %}bg-indigo-600 text-white{% else %}bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white{% endif %} rounded-lg hover:bg-indigo-700 hover:text-white transition duration-300">
            All Departments
          </a>
          {% for dept in departments %}
            <a href="{% url 'staff_section:staff_dash' %}?department={{ dept.id }}{% if selected_doctor %}&doctor={{ selected_doctor }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}"
               class="py-2 px-4 {% if selected_department == dept.id|stringformat:'s' %}bg-indigo-600 text-white{% else %}bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white{% endif %} rounded-lg hover:bg-indigo-700 hover:text-white transition duration-300">
              {{ dept.name }}
            </a>
          {% endfor %}
        </div>
      </div>

      <!-- Doctor Filter -->
      <div class="mb-6">
        <h4 class="text-lg font-medium dark:text-white mb-2">Doctor Filter</h4>
        <div class="flex flex-wrap gap-4">
          <a href="{% url 'staff_section:staff_dash' %}{% if selected_department %}?department={{ selected_department }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}"
             class="py-2 px-4 {% if not selected_doctor %}bg-indigo-600 text-white{% else %}bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white{% endif %} rounded-lg hover:bg-indigo-700 hover:text-white transition duration-300">
            All Doctors
          </a>
          {% for doctor in all_doctors %}
            <a href="{% url 'staff_section:staff_dash' %}?doctor={{ doctor.id }}{% if selected_department %}&department={{ selected_department }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}"
               class="py-2 px-4 {% if selected_doctor == doctor.id|stringformat:'s' %}bg-indigo-600 text-white{% else %}bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white{% endif %} rounded-lg hover:bg-indigo-700 hover:text-white transition duration-300">
              {{ doctor.user.get_full_name|default:doctor.user.username }}
            </a>
          {% endfor %}
        </div>
      </div>

      <!-- Doctor Search -->
      <div>
        <h4 class="text-lg font-medium dark:text-white mb-2">Search Doctors</h4>
        <form action="{% url 'staff_section:staff_dash' %}" method="get" class="flex">
          {% if selected_department %}<input type="hidden" name="department" value="{{ selected_department }}">{% endif %}
          {% if selected_doctor %}<input type="hidden" name="doctor" value="{{ selected_doctor }}">{% endif %}
          <input type="text" name="search" placeholder="Search by name or email" value="{{ search_query }}"
                 class="flex-grow px-4 py-2 rounded-l-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-r-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
            Search
          </button>
        </form>
      </div>
    </div>

    <!-- Department Doctors with Performance Metrics -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-10">
      <h3 class="text-2xl font-semibold dark:text-white mb-4">Doctor Performance</h3>
      {% if doctors %}
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-700">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Name</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Email</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Speciality</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Departments</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Total Logs</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Reviewed Logs</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Monthly Logs</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Performance</th>
              </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
              {% for doctor in doctors %}
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">{{ doctor.name }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">{{ doctor.email }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">{{ doctor.speciality|default:"Not specified" }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">{{ doctor.departments }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">{{ doctor.total_logs }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">{{ doctor.reviewed_logs }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">{{ doctor.monthly_logs }}</td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    {% if doctor.total_logs > 0 %}
                      <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                        {% with performance_percentage=doctor.review_percentage %}
                          {% if performance_percentage > 70 %}
                            <div class="bg-green-600 h-2.5 rounded-full" style="width: {{ performance_percentage }}%"></div>
                          {% elif performance_percentage > 40 %}
                            <div class="bg-yellow-600 h-2.5 rounded-full" style="width: {{ performance_percentage }}%"></div>
                          {% else %}
                            <div class="bg-red-600 h-2.5 rounded-full" style="width: {% if performance_percentage < 2 %}2{% else %}{{ performance_percentage }}{% endif %}%"></div>
                          {% endif %}
                        {% endwith %}
                      </div>
                      <span class="text-xs text-gray-500 dark:text-gray-400">{{ doctor.review_percentage }}% reviewed</span>
                    {% else %}
                      <span class="text-xs text-gray-500 dark:text-gray-400">No data</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-gray-500 dark:text-gray-400 text-center">No doctors found matching your criteria.</p>
      {% endif %}
    </div>

    <!-- Chart.js Visualization -->
    <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg animate-fade-in">
      <h3 class="text-2xl font-semibold dark:text-white mb-6">Record Review Overview</h3>
      <div id="chart-container" style="position: relative; height: 300px;">
        <canvas id="reviewChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Chart.js Script -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Create a one-time initialization function
    var initializeChart = function() {
      // Get the chart container and clear it
      var container = document.getElementById('chart-container');
      if (!container) return;

      // Remove any existing canvas and create a new one
      container.innerHTML = '';
      var canvas = document.createElement('canvas');
      canvas.id = 'reviewChart';
      container.appendChild(canvas);

      // Get the context
      var ctx = canvas.getContext('2d');
      if (!ctx) return;

      // Chart data - ensure we're using integers
      var totalRecords = {{ total_records|default:0 }};
      var leftToReview = {{ left_to_review|default:0 }};
      var reviewed = {{ reviewed|default:0 }};

      // Log the values to console for debugging
      console.log('Chart Data:', {totalRecords, leftToReview, reviewed});

      // Create the chart
      var chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Total Records', 'Left to Review', 'Reviewed'],
          datasets: [{
            label: 'Review Status',
            data: [totalRecords, leftToReview, reviewed],
            backgroundColor: [
              'rgba(139, 92, 246, 0.7)',  // Purple
              'rgba(239, 68, 68, 0.7)',   // Red
              'rgba(16, 185, 129, 0.7)'   // Green
            ],
            borderColor: [
              'rgba(139, 92, 246, 1)',
              'rgba(239, 68, 68, 1)',
              'rgba(16, 185, 129, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });

      // Return the chart instance
      return chart;
    };

    // Initialize the chart when the DOM is fully loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        initializeChart();
      });
    } else {
      initializeChart();
    }
  </script>
{% endblock %}
