{% extends 'base.html' %}

{% block title %}
  Doctor Profile
{% endblock %}

{% block navbar %}
  {% include './components/doc_auth_navbar.html' %}
{% endblock %}

{% block content %}
  <div class="container mx-auto px-4 py-8 max-w-6xl">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl p-6 transition-colors duration-200">
      <!-- Profile Header with Edit Icon -->
      <div class="flex justify-between items-center mb-6 border-b border-gray-200 dark:border-gray-700 pb-4">
        <h1 class="text-3xl font-bold text-gray-800 dark:text-white flex items-center">
          <i class="fas fa-user-md mr-3 text-blue-500"></i>Doctor Profile
        </h1>
        <div class="text-sm text-gray-500 dark:text-gray-400">
          <span class="bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 px-2 py-1 rounded-full">Active</span>
        </div>
      </div>

      <!-- Profile Content -->
      <div class="grid md:grid-cols-2 gap-6">
        <!-- Left Column -->
        <div class="space-y-6">
          <!-- Profile Picture -->
          <div class="flex flex-col items-center justify-center bg-gray-50 dark:bg-gray-700 p-6 rounded-xl transition-all duration-300 transform hover:shadow-md">
            <div class="relative group mb-4">
              <div class="w-40 h-40 rounded-full overflow-hidden border-4 border-blue-500 dark:border-blue-400 shadow-lg">
                <img
                  src="{{ profile_photo }}"
                  alt="Profile Photo"
                  onerror="this.src='/media/profiles/default.jpg';"
                  class="w-full h-full object-cover transition-transform duration-500 transform group-hover:scale-110"
                  loading="lazy"
                />
              </div>

              <!-- Upload Button -->
              <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all duration-300">
                <label for="profile-photo-upload" class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105">
                  <i class="fas fa-camera mr-2"></i> Change Photo
                </label>
              </div>

              <!-- Hidden File Input -->
              <form id="profile-photo-form" hx-post="{% url 'doctor_section:update_profile_photo' %}" hx-encoding="multipart/form-data" class="hidden">
                {% csrf_token %}
                <input type="file" id="profile-photo-upload" name="profile_photo" accept="image/*" class="hidden" />
              </form>
            </div>

            <h2 class="text-2xl font-bold text-gray-800 dark:text-white">{{ full_name }}</h2>
            <p class="text-blue-600 dark:text-blue-400 font-medium">{{ user_speciality }}</p>
          </div>

          <!-- Personal Information -->
          <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-xl shadow-sm transition-all duration-300 hover:shadow-md">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4 flex items-center">
              <i class="fas fa-id-card text-blue-500 mr-2"></i> Personal Information
            </h2>
            <div class="space-y-4">
              <div class="flex items-center p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-200">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center mr-3">
                  <i class="fas fa-envelope text-blue-500 dark:text-blue-300"></i>
                </div>
                <div class="flex-grow">
                  <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Email</p>
                  <p class="font-medium text-gray-800 dark:text-white break-all">{{ user_email }}</p>
                </div>
              </div>

              <div class="flex items-center p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-200">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center mr-3">
                  <i class="fas fa-user-tag text-green-500 dark:text-green-300"></i>
                </div>
                <div class="flex-grow">
                  <p class="text-sm font-medium text-gray-500 dark:text-gray-400">User Role</p>
                  <p class="font-medium text-gray-800 dark:text-white">{{ user_role }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column -->
        <div class="space-y-6">
          <!-- Contact Information -->
          <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-xl shadow-sm transition-all duration-300 hover:shadow-md">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-xl font-semibold text-gray-800 dark:text-white flex items-center">
                <i class="fas fa-address-card text-blue-500 mr-2"></i> Contact Information
              </h2>
              <!-- Button to open the modal -->
              <button id="openModal" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 flex items-center shadow-sm hover:shadow-md">
                <i class="fas fa-edit mr-2"></i> Edit
              </button>
            </div>

            <div class="space-y-4">
              <div class="flex items-center p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-200">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-purple-100 dark:bg-purple-900 flex items-center justify-center mr-3">
                  <i class="fas fa-phone-alt text-purple-500 dark:text-purple-300"></i>
                </div>
                <div class="flex-grow">
                  <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Phone</p>
                  <p id="phone-text" class="font-medium text-gray-800 dark:text-white">{{ user_phone|default:'Not provided' }}</p>
                </div>
              </div>

              <div class="flex items-center p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-200">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center mr-3">
                  <i class="fas fa-city text-indigo-500 dark:text-indigo-300"></i>
                </div>
                <div class="flex-grow">
                  <p class="text-sm font-medium text-gray-500 dark:text-gray-400">City</p>
                  <p id="city-text" class="font-medium text-gray-800 dark:text-white">{{ user_city|default:'Not provided' }}</p>
                </div>
              </div>

              <div class="flex items-center p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-200">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-red-100 dark:bg-red-900 flex items-center justify-center mr-3">
                  <i class="fas fa-globe text-red-500 dark:text-red-300"></i>
                </div>
                <div class="flex-grow">
                  <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Country</p>
                  <p id="country-text" class="font-medium text-gray-800 dark:text-white">{{ user_country|default:'Not provided' }}</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Professional Details -->
          <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-xl shadow-sm transition-all duration-300 hover:shadow-md">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4 flex items-center">
              <i class="fas fa-briefcase text-blue-500 mr-2"></i> Professional Details
            </h2>

            <div class="space-y-4">
              <div class="flex items-center p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-200">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-yellow-100 dark:bg-yellow-900 flex items-center justify-center mr-3">
                  <i class="fas fa-stethoscope text-yellow-500 dark:text-yellow-300"></i>
                </div>
                <div class="flex-grow">
                  <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Specialty</p>
                  <p class="font-medium text-gray-800 dark:text-white">{{ user_speciality }}</p>
                </div>
              </div>

              <div class="flex items-center p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-200">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-teal-100 dark:bg-teal-900 flex items-center justify-center mr-3">
                  <i class="fas fa-hospital text-teal-500 dark:text-teal-300"></i>
                </div>
                <div class="flex-grow">
                  <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Department</p>
                  {% if department_list %}
                    <div class="font-medium text-gray-800 dark:text-white">
                      {% for dept in department_list %}
                        <span class="inline-block bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 px-2 py-1 rounded-full text-xs mr-2 mb-2">{{ dept }}</span>
                      {% endfor %}
                    </div>
                  {% else %}
                    <p class="text-gray-500 dark:text-gray-400">No Departments Assigned</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-50 transition-opacity duration-300">
    <div class="flex items-center justify-center min-h-screen px-4">
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
        <div class="p-6">
          <div class="flex justify-between items-center mb-6 border-b border-gray-200 dark:border-gray-700 pb-4">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white flex items-center">
              <i class="fas fa-edit text-blue-500 mr-3"></i>Edit Contact Information
            </h2>
            <button class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 transition-colors duration-200 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" id="closeModal">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <!-- Edit Form -->
          <form hx-post="{% url 'doctor_section:update_contact_info' %}" hx-trigger="submit" class="space-y-6">
            {% csrf_token %}
            <div class="space-y-2">
              <label for="phone" class="block text-gray-700 dark:text-gray-300 font-medium">Phone Number</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                  <i class="fas fa-phone-alt text-gray-400"></i>
                </div>
                <input
                  type="tel"
                  id="phone"
                  name="phone"
                  value="{{ user_phone }}"
                  class="w-full pl-10 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                  placeholder="Enter your phone number"
                />
              </div>
            </div>

            <div class="space-y-2">
              <label for="city" class="block text-gray-700 dark:text-gray-300 font-medium">City</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                  <i class="fas fa-city text-gray-400"></i>
                </div>
                <input
                  type="text"
                  id="city"
                  name="city"
                  value="{{ user_city }}"
                  class="w-full pl-10 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                  placeholder="Enter your city"
                />
              </div>
            </div>

            <div class="space-y-2">
              <label for="country" class="block text-gray-700 dark:text-gray-300 font-medium">Country</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                  <i class="fas fa-globe text-gray-400"></i>
                </div>
                <input
                  type="text"
                  id="country"
                  name="country"
                  value="{{ user_country }}"
                  class="w-full pl-10 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                  placeholder="Enter your country"
                />
              </div>
            </div>

            <div class="flex space-x-4 pt-4">
              <button type="button" id="cancelBtn" class="w-1/2 px-4 py-3 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-white rounded-lg transition-colors duration-200 font-medium">
                Cancel
              </button>
              <button type="submit" class="w-1/2 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors duration-200 font-medium flex items-center justify-center">
                <i class="fas fa-save mr-2"></i> Save Changes
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      const editModal = document.getElementById('editModal');
      const modalContent = document.getElementById('modalContent');
      const openModalBtn = document.getElementById('openModal');
      const closeModalBtn = document.getElementById('closeModal');
      const cancelBtn = document.getElementById('cancelBtn');
      const profilePhotoUpload = document.getElementById('profile-photo-upload');

      // Toast notification system
      function showToast(message, type = 'success') {
        // Create toast container if it doesn't exist
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
          toastContainer = document.createElement('div');
          toastContainer.id = 'toast-container';
          toastContainer.className = 'fixed bottom-4 right-4 z-50 flex flex-col space-y-2';
          document.body.appendChild(toastContainer);
        }

        // Create toast element
        const toast = document.createElement('div');
        toast.className = `px-4 py-3 rounded-lg shadow-lg flex items-center ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white transform transition-all duration-300 translate-y-2 opacity-0`;

        // Add icon based on type
        const icon = document.createElement('i');
        icon.className = `fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2`;
        toast.appendChild(icon);

        // Add message
        const text = document.createElement('span');
        text.textContent = message;
        toast.appendChild(text);

        // Add close button
        const closeBtn = document.createElement('button');
        closeBtn.className = 'ml-auto text-white hover:text-gray-200';
        closeBtn.innerHTML = '<i class="fas fa-times"></i>';
        closeBtn.addEventListener('click', () => removeToast(toast));
        toast.appendChild(closeBtn);

        // Add to container
        toastContainer.appendChild(toast);

        // Animate in
        setTimeout(() => {
          toast.classList.remove('translate-y-2', 'opacity-0');
        }, 10);

        // Auto remove after 5 seconds
        setTimeout(() => removeToast(toast), 5000);
      }

      function removeToast(toast) {
        toast.classList.add('translate-y-2', 'opacity-0');
        setTimeout(() => toast.remove(), 300);
      }

      // Modal functions
      function openModal() {
        editModal.classList.remove('hidden');
        // Trigger animation after a small delay
        setTimeout(() => {
          modalContent.classList.remove('scale-95', 'opacity-0');
          modalContent.classList.add('scale-100', 'opacity-100');
        }, 10);
      }

      function closeModal() {
        modalContent.classList.remove('scale-100', 'opacity-100');
        modalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
          editModal.classList.add('hidden');
        }, 300);
      }

      // Event Listeners
      if (openModalBtn) openModalBtn.addEventListener('click', openModal);
      if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
      if (cancelBtn) cancelBtn.addEventListener('click', closeModal);

      // Close modal when clicking outside
      editModal.addEventListener('click', function(event) {
        if (event.target === this) {
          closeModal();
        }
      });

      // Handle profile photo upload
      if (profilePhotoUpload) {
        profilePhotoUpload.addEventListener('change', function() {
          if (this.files && this.files[0]) {
            const form = document.getElementById('profile-photo-form');
            if (form) {
              // Show loading indicator
              const profileImg = document.querySelector('[alt="Profile Photo"]');
              if (profileImg) {
                profileImg.style.opacity = '0.5';
                const loadingOverlay = document.createElement('div');
                loadingOverlay.className = 'absolute inset-0 flex items-center justify-center bg-black bg-opacity-30 rounded-full';
                loadingOverlay.innerHTML = '<i class="fas fa-spinner fa-spin text-white text-2xl"></i>';
                loadingOverlay.id = 'photo-loading';
                profileImg.parentNode.appendChild(loadingOverlay);
              }

              // Submit the form using HTMX
              htmx.trigger('#profile-photo-form', 'submit');
            }
          }
        });
      }

      // Handle form submissions and responses
      document.body.addEventListener('htmx:afterRequest', function(event) {
        if (event.detail.successful) {
          try {
            const jsonData = JSON.parse(event.detail.xhr.responseText);

            // Handle contact info update
            if (jsonData.success && !jsonData.profile_photo) {
              // Update the contact info without page reload
              if (jsonData.phone) document.getElementById('phone-text').textContent = jsonData.phone;
              if (jsonData.city) document.getElementById('city-text').textContent = jsonData.city;
              if (jsonData.country) document.getElementById('country-text').textContent = jsonData.country;

              // Close modal and show success message
              closeModal();
              showToast('Contact information updated successfully!', 'success');
            }

            // Handle profile photo update
            if (jsonData.success && jsonData.profile_photo) {
              // Remove loading indicator
              const loadingOverlay = document.getElementById('photo-loading');
              if (loadingOverlay) loadingOverlay.remove();

              // Update the profile photo
              const profileImg = document.querySelector('[alt="Profile Photo"]');
              if (profileImg) {
                profileImg.style.opacity = '1';
                profileImg.src = jsonData.profile_photo;
              }

              showToast('Profile photo updated successfully!', 'success');
            }

            // Handle errors
            if (!jsonData.success) {
              showToast(jsonData.error || 'An error occurred', 'error');
            }
          } catch (error) {
            console.error('Error parsing response:', error);
            showToast('An error occurred while processing your request', 'error');
          }
        } else {
          showToast('Request failed. Please try again.', 'error');
        }
      });

      // Add keyboard support for modal
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && !editModal.classList.contains('hidden')) {
          closeModal();
        }
      });
    });
  </script>
{% endblock %}
