{% extends 'base.html' %}

{% block title %}
  Bulk Import Users
{% endblock %}

{% block navbar %}
{% endblock %}

{% block content %}
  {% include 'components/admin_auth_navbar.html' %}
  <div class="container mx-auto px-4 py-8 mt-16">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Bulk Import Users</h2>

      <!-- Messages section -->
      {% if messages %}
        <div class="mb-6">
          {% for message in messages %}
            <div class="p-4 mb-4 rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100{% elif message.tags == 'error' %}bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100{% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-800 dark:text-yellow-100{% else %}bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100{% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Upload Form -->
        <div>
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Upload CSV File</h3>
            <form method="post" enctype="multipart/form-data" class="space-y-4">
              {% csrf_token %}

              <div>
                <label for="{{ form.user_type.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">User Type</label>
                {{ form.user_type }}
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Select the type of users you want to import</p>
              </div>

              <div>
                <label for="{{ form.csv_file.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">CSV File</label>
                {{ form.csv_file }}
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.csv_file.help_text }}</p>
              </div>

              <div class="pt-4">
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-150 ease-in-out">
                  Upload and Import
                </button>
              </div>
            </form>
          </div>

          <!-- Download Sample Templates -->
          <div class="mt-6 bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Download Sample Templates</h3>
            <p class="text-gray-600 dark:text-gray-300 mb-4">Download a sample CSV template for the user type you want to import:</p>

            <div class="space-y-3">
              <a href="{% url 'admin_section:download_user_template' %}?type=student" class="block w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-150 ease-in-out text-center">
                Download Student Template
              </a>
              <a href="{% url 'admin_section:download_user_template' %}?type=doctor" class="block w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-150 ease-in-out text-center">
                Download Doctor Template
              </a>
              <a href="{% url 'admin_section:download_user_template' %}?type=staff" class="block w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-150 ease-in-out text-center">
                Download Staff Template
              </a>
            </div>
          </div>
        </div>

        <!-- Instructions and Results -->
        <div>
          {% if results %}
            <!-- Import Results -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
              <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Import Results</h3>

              <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-green-100 dark:bg-green-800 p-4 rounded-lg text-center">
                  <p class="text-sm text-gray-600 dark:text-gray-300">Successfully Imported</p>
                  <p class="text-2xl font-bold text-green-600 dark:text-green-300">{{ results.success_count }}</p>
                </div>
                <div class="bg-red-100 dark:bg-red-800 p-4 rounded-lg text-center">
                  <p class="text-sm text-gray-600 dark:text-gray-300">Failed to Import</p>
                  <p class="text-2xl font-bold text-red-600 dark:text-red-300">{{ results.error_count }}</p>
                </div>
              </div>

              {% if results.error_messages %}
                <div class="mt-4">
                  <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Error Details:</h4>
                  <div class="bg-red-50 dark:bg-red-900 p-3 rounded-lg max-h-60 overflow-y-auto">
                    <ul class="list-disc pl-5 space-y-1">
                      {% for error in results.error_messages %}
                        <li class="text-sm text-red-600 dark:text-red-300">{{ error }}</li>
                      {% endfor %}
                    </ul>
                    {% if results.total_errors > 10 %}
                      <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
                        Showing 10 of {{ results.total_errors }} errors.
                      </p>
                    {% endif %}
                  </div>
                </div>
              {% endif %}
            </div>
          {% endif %}

          <!-- Instructions -->
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Instructions</h3>

            <div class="space-y-4">
              <div>
                <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Required Fields</h4>
                <ul class="list-disc pl-5 mt-2 space-y-1 text-gray-600 dark:text-gray-300">
                  <li>username (required) - Unique username for login</li>
                  <li>email (required) - Unique email address</li>
                  <li>password (required) - Strong password</li>
                  <li>first_name (required) - Student's first name</li>
                  <li>last_name (required) - Student's last name</li>
                  <li>student_id (required) - Unique student identification number</li>
                  <li>phone_no (required) - Contact number</li>
                  <li>city (required) - Student's city</li>
                  <li>country (required) - Student's country</li>
                </ul>
              </div>

              <div>
                <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Important Notes</h4>
                <ul class="list-disc pl-5 space-y-1 text-gray-600 dark:text-gray-300">
                  <li>Select the appropriate user type before uploading</li>
                  <li>Username and email must be unique in the system</li>
                  <li>For students, Student ID must be unique</li>
                  <li>For students, group can be specified as group name (B1, B2, A1, A2, etc.)</li>
                  <li>Maximum file size: 5MB</li>
                  <li>File must be in CSV format</li>
                  <li>Required fields vary by user type (see examples below)</li>
                </ul>
              </div>

              <div>
                <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Example Formats</h4>

                <h5 class="font-medium text-gray-700 dark:text-gray-300 mt-3 mb-1">Student Format:</h5>
                <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg overflow-x-auto mb-3">
                  <code class="text-sm">
                    username,email,password,first_name,last_name,student_id,group,phone_no,city,country<br>
                    john.doe,john.doe@example.com,SecurePass123,John,Doe,STU001,B1,1234567890,New York,USA<br>
                    jane.smith,jane.smith@example.com,SecurePass456,Jane,Smith,STU002,A2,0987654321,London,UK
                  </code>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Note: For the 'group' column, use the group name (A1, A2, B1, B2, etc.) rather than the group ID number.</p>

                <h5 class="font-medium text-gray-700 dark:text-gray-300 mt-3 mb-1">Doctor Format:</h5>
                <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg overflow-x-auto mb-3">
                  <code class="text-sm">
                    username,email,password,first_name,last_name,speciality,phone_no,city,country<br>
                    john.doc,john.doc@example.com,SecurePass123,John,Doctor,Cardiology,1234567890,New York,USA<br>
                    jane.doc,jane.doc@example.com,SecurePass456,Jane,Doctor,Neurology,0987654321,London,UK
                  </code>
                </div>

                <h5 class="font-medium text-gray-700 dark:text-gray-300 mt-3 mb-1">Staff Format:</h5>
                <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg overflow-x-auto">
                  <code class="text-sm">
                    username,email,password,first_name,last_name,phone_no,city,country<br>
                    john.staff,john.staff@example.com,SecurePass123,John,Staff,1234567890,New York,USA<br>
                    jane.staff,jane.staff@example.com,SecurePass456,Jane,Staff,0987654321,London,UK
                  </code>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Show different sample data based on selected user type
      const userTypeSelect = document.getElementById('{{ form.user_type.id_for_label }}');

      if (userTypeSelect) {
        userTypeSelect.addEventListener('change', function() {
          // You can add additional JavaScript here if needed
          console.log('User type changed to:', this.value);
        });
      }
    });
  </script>
{% endblock %}

