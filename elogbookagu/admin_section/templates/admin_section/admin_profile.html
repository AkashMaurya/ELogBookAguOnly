{% extends 'base.html' %}
{% block title %}
  Admin Profile
{% endblock %}

{% block navbar %}
  {% include 'components/admin_auth_navbar.html' %}
{% endblock %}

{% block content %}
  <div class="container mx-auto px-4 py-8 min-h-screen">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 transition-colors duration-200">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Admin Profile</h1>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Left Column -->
        <div class="space-y-4">
          <!-- Profile Photo -->
          <div class="flex justify-center">
            <div class="w-24 h-24 sm:w-28 sm:h-28 md:w-32 md:h-32 group">
              <img src="{{ profile_photo }}" alt="Profile Photo" onerror="this.src='/media/profiles/default.jpg';" class="w-full h-full rounded-full object-cover border-2 border-blue-500 dark:border-blue-400 transition-all duration-200" />
              <div class="relative inset-0 hidden group-hover:flex items-center justify-center bg-black bg-opacity-50 rounded-full transition-opacity duration-200">
                <label for="profile-photo-upload" class="cursor-pointer text-white text-sm md:text-base font-medium">Change Photo</label>
              </div>
              <form id="profile-photo-form" hx-post="{% url 'doctor_section:update_profile_photo' %}" hx-encoding="multipart/form-data" class="hidden">
                {% csrf_token %}
                <input type="file" id="profile-photo-upload" name="profile_photo" accept="image/*" class="hidden" />
              </form>
            </div>
          </div>

          <!-- Personal Information -->
          <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg transition-colors duration-200">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4">Personal Information</h2>
            <dl class="space-y-3 text-sm md:text-base">
              <div class="flex flex-col sm:flex-row sm:items-center">
                <dt class="font-medium w-32 text-gray-700 dark:text-gray-300">Full Name:</dt>
                <dd class="dark:text-white">{{ full_name }}</dd>
              </div>
              <div class="flex flex-col sm:flex-row sm:items-center">
                <dt class="font-medium w-32 text-gray-700 dark:text-gray-300">Email:</dt>
                <dd class="dark:text-white break-all">{{ user_email }}</dd>
              </div>
              <div class="flex flex-col sm:flex-row sm:items-center">
                <dt class="font-medium w-32 text-gray-700 dark:text-gray-300">Specialty:</dt>
                <dd class="dark:text-white">{{ user_speciality }}</dd>
              </div>
            </dl>
          </div>
        </div>

        <!-- Right Column -->
        <div class="space-y-4">
          <!-- Contact Information -->
          <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg transition-colors duration-200">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4">Contact Information</h2>
            <dl class="space-y-3 text-sm md:text-base">
              <div class="flex flex-col sm:flex-row sm:items-center">
                <dt class="font-medium w-32 text-gray-700 dark:text-gray-300">Phone:</dt>
                <dd id="phone-text" class="dark:text-white">{{ user_phone }}</dd>
              </div>
              <div class="flex flex-col sm:flex-row sm:items-center">
                <dt class="font-medium w-32 text-gray-700 dark:text-gray-300">City:</dt>
                <dd id="city-text" class="dark:text-white">{{ user_city }}</dd>
              </div>
              <div class="flex flex-col sm:flex-row sm:items-center">
                <dt class="font-medium w-32 text-gray-700 dark:text-gray-300">Country:</dt>
                <dd id="country-text" class="dark:text-white">{{ user_country }}</dd>
              </div>
            </dl>
            <button id="openModal" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">Edit</button>
          </div>

          <!-- Professional Details -->
          <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg transition-colors duration-200">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4">Professional Details</h2>
            <dl class="space-y-3 text-sm md:text-base">
              <div class="flex flex-col sm:flex-row sm:items-center">
                <dt class="font-medium w-32 text-gray-700 dark:text-gray-300">User Role:</dt>
                <dd class="dark:text-white">{{ user_role }}</dd>
              </div>
              <div class="flex flex-col sm:flex-row sm:items-center">
                <dt class="font-medium w-32 text-gray-700 dark:text-gray-300">Department:</dt>
                <div class="dark:text-white">
                  {% if doctor_departments %}
                    {{ doctor_departments }}
                  {% else %}
                    <span class="text-gray-500 dark:text-gray-400">No Departments</span>
                  {% endif %}
                </div>
              </div>
            </dl>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4 py-6">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold dark:text-white">Edit Contact Information</h2>
            <button id="closeModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300"><i class="fas fa-times"></i></button>
          </div>

          <form hx-post="{% url 'doctor_section:update_contact_info' %}" hx-trigger="submit">
            {% csrf_token %}
            <div class="space-y-4">
              <div>
                <label for="phone" class="block text-gray-700 dark:text-gray-300">Phone:</label>
                <input type="text" id="phone" name="phone" value="{{ user_phone }}" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white dark:border-gray-600 transition-colors duration-200" />
              </div>
              <div>
                <label for="city" class="block text-gray-700 dark:text-gray-300">City:</label>
                <input type="text" id="city" name="city" value="{{ user_city }}" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white dark:border-gray-600 transition-colors duration-200" />
              </div>
              <div>
                <label for="country" class="block text-gray-700 dark:text-gray-300">Country:</label>
                <input type="text" id="country" name="country" value="{{ user_country }}" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white dark:border-gray-600 transition-colors duration-200" />
              </div>
              <button type="submit" class="w-full mt-4 px-4 py-2 bg-blue-500 hover:bg-blue-700 text-white rounded-lg transition-colors duration-200">Save Changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
  <script>
    // Modal controls
    const editModal = document.getElementById('editModal')
    document.getElementById('openModal').addEventListener('click', () => editModal.classList.remove('hidden'))
    document.getElementById('closeModal').addEventListener('click', () => editModal.classList.add('hidden'))
    editModal.addEventListener('click', (event) => {
      if (event.target === editModal) editModal.classList.add('hidden')
    })
    
    // Profile photo upload
    document.getElementById('profile-photo-upload').addEventListener('change', function () {
      if (this.files && this.files[0]) {
        htmx.trigger('#profile-photo-form', 'submit')
      }
    })
    
    // HTMX response handling
    document.body.addEventListener('htmx:afterRequest', (event) => {
      if (event.detail.successful) {
        try {
          const jsonData = JSON.parse(event.detail.xhr.responseText)
          if (jsonData.success) {
            if (jsonData.profile_photo) {
              document.querySelector('[alt="Profile Photo"]').src = jsonData.profile_photo
              alert('Profile photo updated successfully!')
            } else {
              editModal.classList.add('hidden')
              document.getElementById('phone-text').textContent = jsonData.phone || document.getElementById('phone').value
              document.getElementById('city-text').textContent = jsonData.city || document.getElementById('city').value
              document.getElementById('country-text').textContent = jsonData.country || document.getElementById('country').value
              alert('Contact information updated successfully!')
            }
          } else {
            alert(jsonData.error || 'Failed to update information')
          }
        } catch (error) {
          console.error('Error parsing response:', error)
          alert('An error occurred while updating information')
        }
      } else {
        alert('Failed to update information. Please try again.')
      }
    })
  </script>
{% endblock %}
