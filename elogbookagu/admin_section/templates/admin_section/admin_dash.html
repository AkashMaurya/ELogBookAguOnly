{% extends 'base.html' %}

{% block title %}
  Admin Dashboard
{% endblock %}

{% block navbar %}

{% endblock %}

{% block content %}
  {% include 'components/admin_auth_navbar.html' %}
  <div class="px-4 sm:px-6 lg:px-8 py-8 transition-all duration-300 max-w-7xl mx-auto">
    <!-- Welcome Section -->
    <div class="bg-gradient-to-r from-blue-600 to-indigo-700 dark:from-blue-800 dark:to-indigo-900 rounded-xl shadow-lg p-8 mb-8 mt-6 relative overflow-hidden">
      <div class="absolute right-0 top-0 opacity-10">
        <i class="fas fa-chart-line text-white text-9xl transform rotate-12 translate-x-8 -translate-y-8"></i>
      </div>
      <div class="relative z-10">
        <h2 class="text-3xl font-bold text-white mb-2 flex items-center">
          <i class="fas fa-tachometer-alt mr-3"></i> Admin Dashboard
        </h2>
        <p class="text-white text-lg max-w-3xl font-medium">Manage your e-logbook system efficiently from this central hub. Monitor student activities, review logs, and track performance metrics.</p>
        <div class="mt-4 flex flex-wrap gap-3">
          <a href="{% url 'admin_section:admin_reviews' %}" class="inline-flex items-center px-4 py-2 bg-white hover:bg-opacity-90 rounded-lg text-blue-700 font-medium transition-all duration-200 shadow-sm">
            <i class="fas fa-clipboard-check mr-2"></i> Review Logs
          </a>
          <a href="{% url 'admin_section:add_department' %}" class="inline-flex items-center px-4 py-2 bg-white hover:bg-opacity-90 rounded-lg text-blue-700 font-medium transition-all duration-200 shadow-sm">
            <i class="fas fa-building mr-2"></i> Manage Departments
          </a>
          <a href="{% url 'admin_section:bulk_import_users' %}" class="inline-flex items-center px-4 py-2 bg-white hover:bg-opacity-90 rounded-lg text-blue-700 font-medium transition-all duration-200 shadow-sm">
            <i class="fas fa-user-plus mr-2"></i> Add Users
          </a>
        </div>
      </div>
    </div>

    <!-- Quick Stats Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
      <!-- Students Card -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300 border-b-4 border-blue-500">
        <div class="p-4 bg-blue-100 dark:bg-blue-900/50">
          <div class="flex items-center justify-between">
            <p class="text-sm font-semibold text-blue-800 dark:text-blue-100">Total Students</p>
            <div class="p-2 rounded-full bg-blue-600 text-white shadow-sm">
              <i class="fas fa-user-graduate"></i>
            </div>
          </div>
        </div>
        <div class="px-4 py-4">
          <div class="flex items-center">
            <p class="text-2xl font-bold text-gray-900 dark:text-white">{{total_student}}</p>
            <div class="ml-auto text-blue-600 dark:text-blue-400">
              <i class="fas fa-chart-line"></i>
            </div>
          </div>
          <p class="text-xs font-medium text-gray-700 dark:text-gray-300 mt-1">Registered in the system</p>
        </div>
      </div>

      <!-- Doctors Card -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300 border-b-4 border-green-500">
        <div class="p-4 bg-green-100 dark:bg-green-900/50">
          <div class="flex items-center justify-between">
            <p class="text-sm font-semibold text-green-800 dark:text-green-100">Total Doctors</p>
            <div class="p-2 rounded-full bg-green-600 text-white shadow-sm">
              <i class="fas fa-user-md"></i>
            </div>
          </div>
        </div>
        <div class="px-4 py-4">
          <div class="flex items-center">
            <p class="text-2xl font-bold text-gray-900 dark:text-white">{{total_doctors}}</p>
            <div class="ml-auto text-green-600 dark:text-green-400">
              <i class="fas fa-stethoscope"></i>
            </div>
          </div>
          <p class="text-xs font-medium text-gray-700 dark:text-gray-300 mt-1">Active supervisors</p>
        </div>
      </div>

      <!-- Activities Card -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300 border-b-4 border-purple-500">
        <div class="p-4 bg-purple-100 dark:bg-purple-900/50">
          <div class="flex items-center justify-between">
            <p class="text-sm font-semibold text-purple-800 dark:text-purple-100">Total Activities</p>
            <div class="p-2 rounded-full bg-purple-600 text-white shadow-sm">
              <i class="fas fa-clipboard-list"></i>
            </div>
          </div>
        </div>
        <div class="px-4 py-4">
          <div class="flex items-center">
            <p class="text-2xl font-bold text-gray-900 dark:text-white">{{total_activities}}</p>
            <div class="ml-auto text-purple-600 dark:text-purple-400">
              <i class="fas fa-tasks"></i>
            </div>
          </div>
          <p class="text-xs font-medium text-gray-700 dark:text-gray-300 mt-1">Available activity types</p>
        </div>
      </div>

      <!-- Records Card -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300 border-b-4 border-amber-500">
        <div class="p-4 bg-amber-100 dark:bg-amber-900/50">
          <div class="flex items-center justify-between">
            <p class="text-sm font-semibold text-amber-800 dark:text-amber-100">Total Records</p>
            <div class="p-2 rounded-full bg-amber-600 text-white shadow-sm">
              <i class="fas fa-file-alt"></i>
            </div>
          </div>
        </div>
        <div class="px-4 py-4">
          <div class="flex items-center">
            <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ total_logs }}</p>
            <div class="ml-auto text-amber-600 dark:text-amber-400">
              <i class="fas fa-clipboard-check"></i>
            </div>
          </div>
          <p class="text-xs font-medium text-gray-700 dark:text-gray-300 mt-1">Total log entries</p>
        </div>
      </div>

      <!-- Departments Card -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300 border-b-4 border-cyan-500">
        <div class="p-4 bg-cyan-100 dark:bg-cyan-900/50">
          <div class="flex items-center justify-between">
            <p class="text-sm font-semibold text-cyan-800 dark:text-cyan-100">Total Departments</p>
            <div class="p-2 rounded-full bg-cyan-600 text-white shadow-sm">
              <i class="fas fa-building"></i>
            </div>
          </div>
        </div>
        <div class="px-4 py-4">
          <div class="flex items-center">
            <p class="text-2xl font-bold text-gray-900 dark:text-white">{{total_departments}}</p>
            <div class="ml-auto text-cyan-600 dark:text-cyan-400">
              <i class="fas fa-sitemap"></i>
            </div>
          </div>
          <p class="text-xs font-medium text-gray-700 dark:text-gray-300 mt-1">Active departments</p>
        </div>
      </div>
    </div>


    <!-- Filter Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- Department Filter -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border-t-4 border-indigo-500">
        <div class="px-6 py-4 bg-indigo-100 dark:bg-indigo-900/50 border-b border-gray-200 dark:border-gray-700">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
            <i class="fas fa-filter text-indigo-600 dark:text-indigo-400 mr-2"></i> Department Filter
          </h3>
        </div>
        <div class="p-6">
          <form method="get" action="{% url 'admin_section:admin_dash' %}" class="space-y-4">
            <div class="space-y-2">
              <label for="department" class="block text-sm font-medium text-gray-800 dark:text-gray-200">
                Select Department <span class="text-gray-600 dark:text-gray-400 text-xs">(Filter dashboard data)</span>
              </label>
              <div class="relative rounded-md shadow-sm">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i class="fas fa-building text-indigo-500 dark:text-indigo-400"></i>
                </div>
                <select id="department" name="department" class="pl-10 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                  <option value="">All Departments</option>
                  {% for dept in departments %}
                    <option value="{{ dept.id }}" {% if selected_department == dept.id|stringformat:'s' %}selected{% endif %}>{{ dept.name }}</option>
                  {% endfor %}
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300">
                  <i class="fas fa-chevron-down"></i>
                </div>
              </div>
            </div>

            <div class="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
              {% if selected_department %}
                <a href="{% url 'admin_section:admin_dash' %}" class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-800 dark:text-gray-100 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                  <i class="fas fa-times mr-2"></i> Clear Filter
                </a>
              {% else %}
                <div></div>
              {% endif %}
              <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <i class="fas fa-filter mr-2"></i> Apply Filter
              </button>
            </div>
          </form>

          {% if selected_department and doctor_performance %}
          <!-- Doctor Performance Chart for Selected Department -->
          <div class="mt-6">
            <div class="flex justify-between items-center mb-4">
              <h4 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="fas fa-user-md text-indigo-600 dark:text-indigo-400 mr-2"></i> Doctor Performance
              </h4>
              <span class="px-3 py-1 bg-indigo-100 text-indigo-800 dark:bg-indigo-900/50 dark:text-indigo-100 rounded-full text-xs font-medium border border-indigo-200 dark:border-indigo-800">
                <i class="fas fa-users mr-1"></i> {{ doctor_performance|length }} Doctors
              </span>
            </div>
            <div class="h-64 bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
              <canvas id="doctorPerformanceChart"></canvas>
            </div>

            <!-- Doctor List Table -->
            <div class="mt-4 overflow-x-auto bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
              <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead>
                  <tr class="bg-gray-50 dark:bg-gray-700">
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-700 dark:text-gray-200 uppercase tracking-wider">Doctor</th>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-700 dark:text-gray-200 uppercase tracking-wider">Reviewed</th>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-700 dark:text-gray-200 uppercase tracking-wider">Approved</th>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-700 dark:text-gray-200 uppercase tracking-wider">Rejected</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                  {% for doctor in doctor_performance %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                      <td class="px-3 py-2 whitespace-nowrap">
                        <div class="flex items-center">
                          <div class="flex-shrink-0 h-6 w-6 rounded-full bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center mr-2">
                            <i class="fas fa-user-md text-indigo-500 dark:text-indigo-400 text-xs"></i>
                          </div>
                          <div class="text-sm font-medium text-gray-900 dark:text-white">{{ doctor.name }}</div>
                        </div>
                      </td>
                      <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">{{ doctor.reviewed }}</td>
                      <td class="px-3 py-2 whitespace-nowrap">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-100 border border-green-200 dark:border-green-800">
                          {{ doctor.approved }}
                        </span>
                      </td>
                      <td class="px-3 py-2 whitespace-nowrap">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-100 border border-red-200 dark:border-red-800">
                          {{ doctor.rejected }}
                        </span>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          {% endif %}
        </div>

      <!-- User Information Card -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border-t-4 border-teal-500">
        <div class="px-6 py-4 bg-teal-100 dark:bg-teal-900/50 border-b border-gray-200 dark:border-gray-700">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
            <i class="fas fa-users text-teal-600 dark:text-teal-400 mr-2"></i> User Information
          </h3>
        </div>
        <div class="p-6">
          <div class="space-y-4">
            <div class="space-y-2">
              <label for="user_type" class="block text-sm font-medium text-gray-800 dark:text-gray-200">
                Select User Type <span class="text-gray-600 dark:text-gray-400 text-xs">(View user details)</span>
              </label>
              <div class="relative rounded-md shadow-sm">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i class="fas fa-user-tag text-teal-500 dark:text-teal-400"></i>
                </div>
                <select id="user_type" class="pl-10 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                  <option value="">Select User Type</option>
                  <option value="student">Students</option>
                  <option value="doctor">Doctors</option>
                  <option value="staff">Staff</option>
                  <option value="admin">Admins</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300">
                  <i class="fas fa-chevron-down"></i>
                </div>
              </div>
            </div>

            <div class="flex justify-end">
              <button id="loadUserData" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">
                <i class="fas fa-database mr-2"></i> Load Data
              </button>
            </div>
          </div>

          <!-- Loading Indicator -->
          <div id="userDataLoading" class="mt-6 hidden">
            <div class="flex justify-center items-center p-6 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
              <div class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-6 w-6 border-2 border-t-2 border-teal-500"></div>
                <span class="text-gray-800 dark:text-gray-200 text-sm font-medium">Loading user data...</span>
              </div>
            </div>
          </div>

          <!-- User Data Container -->
          <div id="userDataContainer" class="mt-6 hidden">
            <div class="bg-gray-50 dark:bg-gray-700 p-5 rounded-lg border border-gray-200 dark:border-gray-600">
              <div id="userDataContent" class="text-sm text-gray-800 dark:text-gray-200">
                <!-- User data will be loaded here -->
                <div class="flex flex-col items-center justify-center py-6">
                  <i class="fas fa-users text-teal-500 dark:text-teal-400 text-3xl mb-2"></i>
                  <p class="text-center text-gray-700 dark:text-gray-300 font-medium">Select a user type and click 'Load Data' to view information</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      </div>
    </div>

    <!-- Performance Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- Pie Chart: Review Status -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border-t-4 border-rose-500">
        <div class="px-6 py-4 bg-rose-100 dark:bg-rose-900/50 border-b border-gray-200 dark:border-gray-700">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
            <i class="fas fa-chart-pie text-rose-600 dark:text-rose-400 mr-2"></i> Review Status
          </h3>
        </div>
        <div class="p-6">
          <div class="h-64 bg-white dark:bg-gray-800 rounded-lg border border-gray-100 dark:border-gray-700 p-2">
            <canvas id="reviewStatusChart"></canvas>
          </div>
          <div class="grid grid-cols-3 gap-2 mt-4 text-center text-sm">
            <div class="p-2 rounded-lg bg-green-100 dark:bg-green-900/50 border border-green-200 dark:border-green-800">
              <div class="font-medium text-green-800 dark:text-green-100">Approved</div>
              <div class="text-lg font-bold text-green-700 dark:text-green-300">{{ approved_logs }}</div>
            </div>
            <div class="p-2 rounded-lg bg-amber-100 dark:bg-amber-900/50 border border-amber-200 dark:border-amber-800">
              <div class="font-medium text-amber-800 dark:text-amber-100">Pending</div>
              <div class="text-lg font-bold text-amber-700 dark:text-amber-300">{{ pending_logs }}</div>
            </div>
            <div class="p-2 rounded-lg bg-red-100 dark:bg-red-900/50 border border-red-200 dark:border-red-800">
              <div class="font-medium text-red-800 dark:text-red-100">Rejected</div>
              <div class="text-lg font-bold text-red-700 dark:text-red-300">{{ rejected_logs }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Bar Chart: Department Performance -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border-t-4 border-blue-500">
        <div class="px-6 py-4 bg-blue-100 dark:bg-blue-900/50 border-b border-gray-200 dark:border-gray-700">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
            <i class="fas fa-chart-bar text-blue-600 dark:text-blue-400 mr-2"></i> Department Performance
          </h3>
        </div>
        <div class="p-6">
          <div class="h-64 bg-white dark:bg-gray-800 rounded-lg border border-gray-100 dark:border-gray-700 p-2">
            <canvas id="departmentChart"></canvas>
          </div>
          <div class="mt-4 text-center text-sm">
            <div class="inline-flex items-center px-3 py-1 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-100 border border-blue-200 dark:border-blue-800">
              <i class="fas fa-info-circle mr-1"></i> Showing data for {{ chart_data.department_stats|length }} departments
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Student Performance Search -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border-t-4 border-orange-500 mb-8">
      <div class="px-6 py-4 bg-orange-100 dark:bg-orange-900/50 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
          <i class="fas fa-user-graduate text-orange-600 dark:text-orange-400 mr-2"></i> Student Performance Search
        </h3>
      </div>
      <div class="p-6">
        <form method="get" action="{% url 'admin_section:admin_dash' %}" class="space-y-4">
          <div class="space-y-2">
            <label for="student_search" class="block text-sm font-medium text-gray-800 dark:text-gray-200">
              Search by Name, ID or Email <span class="text-gray-600 dark:text-gray-400 text-xs">(Find student performance data)</span>
            </label>
            <div class="relative rounded-md shadow-sm">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-search text-orange-500 dark:text-orange-400"></i>
              </div>
              <input type="text" id="student_search" name="student_search" value="{{ student_search }}"
                     class="pl-10 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
                     placeholder="Enter student name, ID or email address">
              {% if student_search %}
              <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                <a href="{% url 'admin_section:admin_dash' %}" class="text-orange-500 hover:text-orange-600 dark:text-orange-400 dark:hover:text-orange-300" title="Clear search">
                  <i class="fas fa-times-circle"></i>
                </a>
              </div>
              {% endif %}
            </div>
          </div>

          <div class="flex justify-end">
            <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">
              <i class="fas fa-search mr-2"></i> Search Student
            </button>
          </div>
        </form>

      {% if student_data %}
        <div class="mt-6 bg-gray-50 dark:bg-gray-700/50 rounded-xl border border-gray-200 dark:border-gray-600 overflow-hidden">
          <!-- Student Profile Header -->
          <div class="p-6 bg-gradient-to-r from-orange-500/20 to-amber-500/20 dark:from-orange-900/40 dark:to-amber-900/40 border-b border-gray-200 dark:border-gray-600">
            <div class="flex flex-col sm:flex-row items-center sm:items-start gap-4">
              <div class="w-16 h-16 rounded-full bg-gradient-to-br from-orange-500 to-amber-500 flex items-center justify-center text-white shadow-lg">
                <i class="fas fa-user-graduate text-2xl"></i>
              </div>
              <div class="text-center sm:text-left">
                <h4 class="text-xl font-bold text-gray-900 dark:text-white">{{ student_data.name }}</h4>
                <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 mt-1 text-sm text-gray-700 dark:text-gray-200">
                  <div class="flex items-center justify-center sm:justify-start">
                    <i class="fas fa-envelope text-orange-500 dark:text-orange-400 mr-1"></i>
                    <span>{{ student_data.email }}</span>
                  </div>
                  <div class="flex items-center justify-center sm:justify-start">
                    <i class="fas fa-id-card text-orange-500 dark:text-orange-400 mr-1"></i>
                    <span>ID: {{ student_data.id }}</span>
                  </div>
                </div>
              </div>
              <div class="ml-auto hidden sm:block">
                <a href="#" class="inline-flex items-center px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium text-gray-800 dark:text-gray-100 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 shadow-sm">
                  <i class="fas fa-file-pdf mr-1.5 text-red-600 dark:text-red-400"></i> Download Report
                </a>
              </div>
            </div>
          </div>

          <!-- Performance Stats -->
          <div class="grid grid-cols-1 sm:grid-cols-3 divide-y sm:divide-y-0 sm:divide-x divide-gray-200 dark:divide-gray-700 border-b border-gray-200 dark:border-gray-700">
            <div class="p-4 sm:p-6 flex items-center">
              <div class="p-3 rounded-full bg-green-100 dark:bg-green-900/50 mr-4 shadow-sm">
                <i class="fas fa-check-circle text-green-600 dark:text-green-300 text-xl"></i>
              </div>
              <div>
                <p class="text-sm font-medium text-gray-700 dark:text-gray-300">Approved Logs</p>
                <p class="text-2xl font-bold text-green-700 dark:text-green-300">{{ student_data.approved_logs }}</p>
              </div>
            </div>
            <div class="p-4 sm:p-6 flex items-center">
              <div class="p-3 rounded-full bg-amber-100 dark:bg-amber-900/50 mr-4 shadow-sm">
                <i class="fas fa-clock text-amber-600 dark:text-amber-300 text-xl"></i>
              </div>
              <div>
                <p class="text-sm font-medium text-gray-700 dark:text-gray-300">Pending Logs</p>
                <p class="text-2xl font-bold text-amber-700 dark:text-amber-300">{{ student_data.pending_logs }}</p>
              </div>
            </div>
            <div class="p-4 sm:p-6 flex items-center">
              <div class="p-3 rounded-full bg-red-100 dark:bg-red-900/50 mr-4 shadow-sm">
                <i class="fas fa-times-circle text-red-600 dark:text-red-300 text-xl"></i>
              </div>
              <div>
                <p class="text-sm font-medium text-gray-700 dark:text-gray-300">Rejected Logs</p>
                <p class="text-2xl font-bold text-red-700 dark:text-red-300">{{ student_data.rejected_logs }}</p>
              </div>
            </div>
          </div>

          {% if student_performance_data %}
          <!-- Student Performance by Department Chart -->
          <div class="p-6">
            <div class="flex items-center justify-between mb-4">
              <h5 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="fas fa-chart-line text-orange-600 dark:text-orange-400 mr-2"></i> Performance by Department
              </h5>
              <div class="text-sm text-gray-700 dark:text-gray-300">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-100 border border-blue-200 dark:border-blue-800">
                  <i class="fas fa-info-circle mr-1"></i> {{ student_performance_data|length }} departments
                </span>
              </div>
            </div>
            <div class="h-64 bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
              <canvas id="studentPerformanceChart"></canvas>
            </div>
          </div>

          <!-- Department Performance Table -->
          <div class="px-6 pb-6">
            <div class="flex items-center justify-between mb-4">
              <h5 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="fas fa-table text-orange-600 dark:text-orange-400 mr-2"></i> Department Details
              </h5>
              <a href="#" class="inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded text-orange-800 bg-orange-100 hover:bg-orange-200 dark:bg-orange-900/50 dark:text-orange-100 dark:hover:bg-orange-900/70 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 shadow-sm">
                <i class="fas fa-download mr-1"></i> Export Data
              </a>
            </div>
            <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
              <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead>
                  <tr class="bg-gray-50 dark:bg-gray-700">
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-200 uppercase tracking-wider">Department</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-200 uppercase tracking-wider">Total</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-200 uppercase tracking-wider">Approved</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-200 uppercase tracking-wider">Pending</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-200 uppercase tracking-wider">Rejected</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                  {% for dept in student_performance_data %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                      <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900 dark:text-white">{{ dept.department }}</div>
                      </td>
                      <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900 dark:text-white">{{ dept.total }}</div>
                      </td>
                      <td class="px-4 py-3 whitespace-nowrap">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-100 border border-green-200 dark:border-green-800">
                          {{ dept.approved }}
                        </span>
                      </td>
                      <td class="px-4 py-3 whitespace-nowrap">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-100 border border-amber-200 dark:border-amber-800">
                          {{ dept.pending }}
                        </span>
                      </td>
                      <td class="px-4 py-3 whitespace-nowrap">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-100 border border-red-200 dark:border-red-800">
                          {{ dept.rejected }}
                        </span>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          {% else %}
          <!-- No Performance Data -->
          <div class="p-6 text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-800 mb-4 shadow-sm">
              <i class="fas fa-chart-bar text-orange-500 dark:text-orange-400 text-2xl"></i>
            </div>
            <h5 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No Performance Data Available</h5>
            <p class="text-gray-700 dark:text-gray-300 max-w-md mx-auto font-medium">This student has not submitted any logs yet or all logs are still pending review.</p>
          </div>
          {% endif %}
        </div>
      {% else %}
        {% if student_search %}
          <div class="mt-6 bg-gray-50 dark:bg-gray-700/50 rounded-xl border border-gray-200 dark:border-gray-600 overflow-hidden shadow-sm">
            <div class="p-8 text-center">
              <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-orange-100 dark:bg-orange-900/50 mb-4 shadow-sm">
                <i class="fas fa-search text-orange-600 dark:text-orange-400 text-2xl"></i>
              </div>
              <h5 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No Results Found</h5>
              <p class="text-gray-700 dark:text-gray-200 max-w-md mx-auto">No student found with the search term <span class="font-medium text-orange-700 dark:text-orange-300">"{{ student_search }}"</span></p>
              <p class="text-sm text-gray-600 dark:text-gray-300 mt-2 mb-4 font-medium">Try searching by name, student ID, or email address</p>
              <a href="{% url 'admin_section:admin_dash' %}" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">
                <i class="fas fa-times mr-2"></i> Clear Search
              </a>
            </div>
          </div>
        {% endif %}
      {% endif %}
    </div>

    <!-- Recent Logs Table -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border-t-4 border-indigo-500 mb-8">
      <div class="px-6 py-4 bg-indigo-100 dark:bg-indigo-900/50 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
          <i class="fas fa-clipboard-list text-indigo-600 dark:text-indigo-400 mr-2"></i> Recent Logs
          <span class="ml-2 px-2 py-1 text-xs rounded-full bg-white text-gray-800 dark:bg-gray-800 dark:text-gray-100 border border-indigo-200 dark:border-indigo-700">{{ recent_logs|length }}</span>
        </h3>
        <a href="{% url 'admin_section:admin_reviews' %}" class="inline-flex items-center px-3 py-1.5 border border-transparent text-sm leading-4 font-medium rounded-md text-indigo-800 bg-indigo-100 hover:bg-indigo-200 dark:bg-indigo-900/50 dark:text-indigo-100 dark:hover:bg-indigo-900/70 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 shadow-sm">
          <i class="fas fa-external-link-alt mr-1.5"></i> View All
        </a>
      </div>

      {% if recent_logs %}
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead>
              <tr class="bg-gray-50 dark:bg-gray-700">
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-200 uppercase tracking-wider">
                  <div class="flex items-center">
                    <span>Student</span>
                    <i class="fas fa-sort ml-1 text-indigo-500 dark:text-indigo-400"></i>
                  </div>
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-200 uppercase tracking-wider">
                  <div class="flex items-center">
                    <span>Date</span>
                    <i class="fas fa-sort ml-1 text-indigo-500 dark:text-indigo-400"></i>
                  </div>
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-200 uppercase tracking-wider">
                  <div class="flex items-center">
                    <span>Department</span>
                    <i class="fas fa-sort ml-1 text-indigo-500 dark:text-indigo-400"></i>
                  </div>
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-200 uppercase tracking-wider">
                  <div class="flex items-center">
                    <span>Activity</span>
                    <i class="fas fa-sort ml-1 text-indigo-500 dark:text-indigo-400"></i>
                  </div>
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-200 uppercase tracking-wider">Status</th>
                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-700 dark:text-gray-200 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
              {% for log in recent_logs %}
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                      <div class="flex-shrink-0 h-8 w-8 rounded-full bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center">
                        <i class="fas fa-user-graduate text-indigo-500 dark:text-indigo-400"></i>
                      </div>
                      <div class="ml-3">
                        <div class="text-sm font-medium text-gray-900 dark:text-white">{{ log.student.user.get_full_name }}</div>
                        <div class="text-xs text-gray-700 dark:text-gray-300 font-medium">ID: {{ log.student.student_id }}</div>
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900 dark:text-white">{{ log.date|date:"M d, Y" }}</div>
                    <div class="text-xs text-gray-700 dark:text-gray-300 font-medium">{{ log.date|time:"h:i A" }}</div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-100 border border-blue-200 dark:border-blue-800">
                      {{ log.department.name }}
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900 dark:text-white">{{ log.activity_type.name }}</div>
                    <div class="text-xs text-gray-700 dark:text-gray-300 font-medium truncate max-w-[150px]" title="{{ log.core_diagnosis.name }}">
                      {{ log.core_diagnosis.name }}
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    {% if log.is_reviewed %}
                      {% if log.reviewer_comments and 'REJECTED:' in log.reviewer_comments %}
                        <span class="px-2 py-1 inline-flex items-center text-xs font-medium rounded-full bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-100 border border-red-200 dark:border-red-800">
                          <i class="fas fa-times-circle mr-1"></i> Rejected
                        </span>
                      {% else %}
                        <span class="px-2 py-1 inline-flex items-center text-xs font-medium rounded-full bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-100 border border-green-200 dark:border-green-800">
                          <i class="fas fa-check-circle mr-1"></i> Approved
                        </span>
                      {% endif %}
                    {% else %}
                      <span class="px-2 py-1 inline-flex items-center text-xs font-medium rounded-full bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-100 border border-amber-200 dark:border-amber-800">
                        <i class="fas fa-clock mr-1"></i> Pending
                      </span>
                    {% endif %}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <a href="{% url 'admin_section:review_log' log.id %}"
                       class="p-1.5 bg-indigo-50 text-indigo-600 rounded hover:bg-indigo-100 dark:bg-indigo-900/30 dark:text-indigo-400 dark:hover:bg-indigo-900/50 transition-colors duration-200"
                       title="{% if log.is_reviewed %}View Details{% else %}Review Log{% endif %}">
                      <i class="fas {% if log.is_reviewed %}fa-eye{% else %}fa-clipboard-check{% endif %}"></i>
                    </a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="p-8 text-center">
          <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-800 mb-4 shadow-sm">
            <i class="fas fa-clipboard-list text-indigo-500 dark:text-indigo-400 text-2xl"></i>
          </div>
          <h5 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No Logs Found</h5>
          <p class="text-gray-700 dark:text-gray-300 max-w-md mx-auto font-medium">There are no recent logs to display at this time.</p>
        </div>
      {% endif %}
    </div>

    <!-- Quick Actions -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border-t-4 border-emerald-500 mb-8">
      <div class="px-6 py-4 bg-emerald-100 dark:bg-emerald-900/50 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
          <i class="fas fa-bolt text-emerald-600 dark:text-emerald-400 mr-2"></i> Quick Actions
        </h3>
      </div>
      <div class="p-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <a href="{% url 'admin_section:add_activity_type' %}" class="group relative flex flex-col items-center p-5 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition-all duration-200 overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-r from-blue-500/5 to-blue-500/10 dark:from-blue-500/10 dark:to-blue-500/20 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left duration-300"></div>
            <div class="relative z-10 flex flex-col items-center">
              <div class="w-12 h-12 flex items-center justify-center rounded-full bg-blue-100 dark:bg-blue-900/50 mb-3 group-hover:scale-110 transition-transform duration-200">
                <i class="fas fa-clipboard-list text-blue-600 dark:text-blue-400 text-xl"></i>
              </div>
              <h4 class="text-sm font-medium text-gray-900 dark:text-white mb-1">Activity Types</h4>
              <p class="text-xs text-gray-700 dark:text-gray-300 text-center font-medium">Manage activity categories</p>
            </div>
          </a>

          <a href="{% url 'admin_section:bulk_import_users' %}" class="group relative flex flex-col items-center p-5 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition-all duration-200 overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-r from-teal-500/5 to-teal-500/10 dark:from-teal-500/10 dark:to-teal-500/20 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left duration-300"></div>
            <div class="relative z-10 flex flex-col items-center">
              <div class="w-12 h-12 flex items-center justify-center rounded-full bg-teal-100 dark:bg-teal-900/50 mb-3 group-hover:scale-110 transition-transform duration-200">
                <i class="fas fa-user-plus text-teal-600 dark:text-teal-400 text-xl"></i>
              </div>
              <h4 class="text-sm font-medium text-gray-900 dark:text-white mb-1">Import Users</h4>
              <p class="text-xs text-gray-700 dark:text-gray-300 text-center font-medium">Bulk add users via CSV</p>
            </div>
          </a>

          <a href="{% url 'admin_section:core_dia_pro_session_list' %}" class="group relative flex flex-col items-center p-5 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition-all duration-200 overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-r from-green-500/5 to-green-500/10 dark:from-green-500/10 dark:to-green-500/20 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left duration-300"></div>
            <div class="relative z-10 flex flex-col items-center">
              <div class="w-12 h-12 flex items-center justify-center rounded-full bg-green-100 dark:bg-green-900/50 mb-3 group-hover:scale-110 transition-transform duration-200">
                <i class="fas fa-calendar-plus text-green-600 dark:text-green-400 text-xl"></i>
              </div>
              <h4 class="text-sm font-medium text-gray-900 dark:text-white mb-1">Session Activities</h4>
              <p class="text-xs text-gray-700 dark:text-gray-300 text-center font-medium">Manage clinical sessions</p>
            </div>
          </a>

          <a href="{% url 'admin_section:admin_reviews' %}" class="group relative flex flex-col items-center p-5 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition-all duration-200 overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-r from-purple-500/5 to-purple-500/10 dark:from-purple-500/10 dark:to-purple-500/20 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left duration-300"></div>
            <div class="relative z-10 flex flex-col items-center">
              <div class="w-12 h-12 flex items-center justify-center rounded-full bg-purple-100 dark:bg-purple-900/50 mb-3 group-hover:scale-110 transition-transform duration-200">
                <i class="fas fa-clipboard-check text-purple-600 dark:text-purple-400 text-xl"></i>
              </div>
              <h4 class="text-sm font-medium text-gray-900 dark:text-white mb-1">Review Logs</h4>
              <p class="text-xs text-gray-700 dark:text-gray-300 text-center font-medium">Approve student activities</p>
            </div>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js Script -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Function to determine text color based on dark mode
      const isDarkMode = () => document.documentElement.classList.contains('dark');
      const textColor = () => (isDarkMode() ? '#ffffff' : '#000000');

      // Review Status Pie Chart
      const reviewStatusCtx = document.getElementById('reviewStatusChart').getContext('2d');
      const reviewStatusChart = new Chart(reviewStatusCtx, {
        type: 'pie',
        data: {
          labels: ['Approved', 'Pending', 'Rejected'],
          datasets: [{
            data: [{{ approved_logs }}, {{ pending_logs }}, {{ rejected_logs }}],
            backgroundColor: [
              'rgba(72, 187, 120, 0.7)',  // Green for approved
              'rgba(237, 137, 54, 0.7)',  // Orange for pending
              'rgba(229, 62, 62, 0.7)'     // Red for rejected
            ],
            borderColor: [
              'rgba(72, 187, 120, 1)',
              'rgba(237, 137, 54, 1)',
              'rgba(229, 62, 62, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: textColor(),
                font: {
                  size: 12
                }
              }
            },
            title: {
              display: true,
              text: 'Log Review Status',
              color: textColor(),
              font: {
                size: 16
              }
            }
          }
        }
      });

      // Department Performance Bar Chart
      const departmentCtx = document.getElementById('departmentChart').getContext('2d');
      const departmentChart = new Chart(departmentCtx, {
        type: 'bar',
        data: {
          labels: [
            {% for dept in chart_data.department_stats %}
              '{{ dept.name }}',
            {% endfor %}
          ],
          datasets: [{
            label: 'Total Logs',
            data: [
              {% for dept in chart_data.department_stats %}
                {{ dept.total }},
              {% endfor %}
            ],
            backgroundColor: 'rgba(66, 153, 225, 0.7)',
            borderColor: 'rgba(66, 153, 225, 1)',
            borderWidth: 1
          }, {
            label: 'Reviewed',
            data: [
              {% for dept in chart_data.department_stats %}
                {{ dept.reviewed }},
              {% endfor %}
            ],
            backgroundColor: 'rgba(72, 187, 120, 0.7)',
            borderColor: 'rgba(72, 187, 120, 1)',
            borderWidth: 1
          }, {
            label: 'Pending',
            data: [
              {% for dept in chart_data.department_stats %}
                {{ dept.pending }},
              {% endfor %}
            ],
            backgroundColor: 'rgba(237, 137, 54, 0.7)',
            borderColor: 'rgba(237, 137, 54, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: {
                color: textColor()
              },
              grid: {
                color: isDarkMode() ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                color: textColor()
              },
              grid: {
                color: isDarkMode() ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
              }
            }
          },
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: textColor(),
                font: {
                  size: 12
                }
              }
            },
            title: {
              display: true,
              text: 'Department Performance',
              color: textColor(),
              font: {
                size: 16
              }
            }
          }
        }
      });

      // Doctor Performance Chart (if department is selected)
      {% if selected_department and doctor_performance %}
      const doctorPerformanceCtx = document.getElementById('doctorPerformanceChart').getContext('2d');
      const doctorPerformanceChart = new Chart(doctorPerformanceCtx, {
        type: 'bar',
        data: {
          labels: [
            {% for doctor in doctor_performance %}
              '{{ doctor.name }}',
            {% endfor %}
          ],
          datasets: [{
            label: 'Reviewed',
            data: [
              {% for doctor in doctor_performance %}
                {{ doctor.reviewed }},
              {% endfor %}
            ],
            backgroundColor: 'rgba(66, 153, 225, 0.7)',
            borderColor: 'rgba(66, 153, 225, 1)',
            borderWidth: 1
          }, {
            label: 'Approved',
            data: [
              {% for doctor in doctor_performance %}
                {{ doctor.approved }},
              {% endfor %}
            ],
            backgroundColor: 'rgba(72, 187, 120, 0.7)',
            borderColor: 'rgba(72, 187, 120, 1)',
            borderWidth: 1
          }, {
            label: 'Rejected',
            data: [
              {% for doctor in doctor_performance %}
                {{ doctor.rejected }},
              {% endfor %}
            ],
            backgroundColor: 'rgba(229, 62, 62, 0.7)',
            borderColor: 'rgba(229, 62, 62, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: {
                color: textColor()
              },
              grid: {
                color: isDarkMode() ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                color: textColor()
              },
              grid: {
                color: isDarkMode() ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
              }
            }
          },
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: textColor(),
                font: {
                  size: 12
                }
              }
            },
            title: {
              display: true,
              text: 'Doctor Performance',
              color: textColor(),
              font: {
                size: 16
              }
            }
          }
        }
      });
      {% endif %}

      // Student Performance Chart (if student is searched)
      {% if student_performance_data %}
      const studentPerformanceCtx = document.getElementById('studentPerformanceChart').getContext('2d');
      const studentPerformanceChart = new Chart(studentPerformanceCtx, {
        type: 'bar',
        data: {
          labels: [
            {% for dept_data in student_performance_data %}
              '{{ dept_data.department }}',
            {% endfor %}
          ],
          datasets: [{
            label: 'Total',
            data: [
              {% for dept_data in student_performance_data %}
                {{ dept_data.total }},
              {% endfor %}
            ],
            backgroundColor: 'rgba(66, 153, 225, 0.7)',
            borderColor: 'rgba(66, 153, 225, 1)',
            borderWidth: 1
          }, {
            label: 'Approved',
            data: [
              {% for dept_data in student_performance_data %}
                {{ dept_data.approved }},
              {% endfor %}
            ],
            backgroundColor: 'rgba(72, 187, 120, 0.7)',
            borderColor: 'rgba(72, 187, 120, 1)',
            borderWidth: 1
          }, {
            label: 'Pending',
            data: [
              {% for dept_data in student_performance_data %}
                {{ dept_data.pending }},
              {% endfor %}
            ],
            backgroundColor: 'rgba(237, 137, 54, 0.7)',
            borderColor: 'rgba(237, 137, 54, 1)',
            borderWidth: 1
          }, {
            label: 'Rejected',
            data: [
              {% for dept_data in student_performance_data %}
                {{ dept_data.rejected }},
              {% endfor %}
            ],
            backgroundColor: 'rgba(229, 62, 62, 0.7)',
            borderColor: 'rgba(229, 62, 62, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: {
                color: textColor()
              },
              grid: {
                color: isDarkMode() ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                color: textColor()
              },
              grid: {
                color: isDarkMode() ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
              }
            }
          },
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: textColor(),
                font: {
                  size: 12
                }
              }
            },
            title: {
              display: true,
              text: 'Student Performance by Department',
              color: textColor(),
              font: {
                size: 16
              }
            }
          }
        }
      });
      {% endif %}

      // Helper function to update common chart colors
      const updateChartAxisAndLegendColors = (chart, textColor, gridColor) => {
        if (!chart) return;
        // Update scales (axes and grid lines) if they exist
        if (chart.options.scales) {
          if (chart.options.scales.x) {
            chart.options.scales.x.ticks.color = textColor;
            chart.options.scales.x.grid.color = gridColor;
          }
          if (chart.options.scales.y) {
            chart.options.scales.y.ticks.color = textColor;
            chart.options.scales.y.grid.color = gridColor;
          }
        }
        // Update legend and title colors
        if (chart.options.plugins) {
          if (chart.options.plugins.legend) {
            chart.options.plugins.legend.labels.color = textColor;
          }
          if (chart.options.plugins.title) {
            chart.options.plugins.title.color = textColor;
          }
        }
        chart.update();
      };

      // Update chart colors when theme changes
      const updateChartColors = () => {
        const newTextColor = textColor();
        const newGridColor = isDarkMode() ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

        updateChartAxisAndLegendColors(reviewStatusChart, newTextColor, newGridColor);
        updateChartAxisAndLegendColors(departmentChart, newTextColor, newGridColor);

        {% if selected_department and doctor_performance %}
        updateChartAxisAndLegendColors(doctorPerformanceChart, newTextColor, newGridColor);
        {% endif %}

        {% if student_performance_data %}
        updateChartAxisAndLegendColors(studentPerformanceChart, newTextColor, newGridColor);
        {% endif %}
      };

      // Listen for theme changes
      const darkModeToggle = document.getElementById('darkModeToggle');
      if (darkModeToggle) {
        darkModeToggle.addEventListener('click', () => {
          setTimeout(updateChartColors, 100); // Small delay to ensure DOM updates
        });
      }

      // User Data Dropdown Functionality
      const userTypeSelect = document.getElementById('user_type');
      const loadUserDataBtn = document.getElementById('loadUserData');
      const userDataContainer = document.getElementById('userDataContainer');
      const userDataContent = document.getElementById('userDataContent');
      const userDataLoading = document.getElementById('userDataLoading');

      loadUserDataBtn.addEventListener('click', function() {
        const userType = userTypeSelect.value;
        if (!userType) {
          alert('Please select a user type');
          return;
        }

        // Hide content and show loading indicator
        userDataContainer.classList.add('hidden');
        userDataLoading.classList.remove('hidden');

        // Make AJAX call to fetch user data
        // Fetch pre-rendered HTML for the selected user type
        fetch(`{% url 'admin_section:get_user_data' %}?user_type=${userType}`)
          .then(response => {
            if (!response.ok) {
              // If response is not OK, try to parse as JSON for potential error message from backend
              return response.text().then(text => {
                try {
                  const errorData = JSON.parse(text);
                  throw new Error(errorData.error || `Server responded with status ${response.status}`);
                } catch (e) {
                  // If not JSON, throw generic error
                  throw new Error(`Server responded with status ${response.status}`);
                }
              });
            }
            // Expecting HTML response
            return response.text();
          })
          .then(htmlData => {
            // Hide loading indicator and show content
            userDataLoading.classList.add('hidden');
            userDataContainer.classList.remove('hidden');

            // Inject the fetched HTML directly
            userDataContent.innerHTML = htmlData;
          })
          .catch(error => {
            // Hide loading indicator and show error message
            userDataLoading.classList.add('hidden');
            userDataContainer.classList.remove('hidden');
            userDataContent.innerHTML = `<div class="p-4 text-center text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900/30 rounded border border-red-200 dark:border-red-800">
                                           <i class="fas fa-exclamation-triangle mr-2"></i>Error loading data: ${error.message}
                                         </div>`;
            console.error('Error fetching user data:', error);
          });
      });
    });
  </script>
{% endblock %}
